---
title: "Group 14 Final Project"
author: "Huiyue Li,  Mai Weijia,  Paul Shen"
date: "2020/11/13"
output:
  word_document: default
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE,message = FALSE,warning = FALSE)
```

## Part 1

### Function

```{r package and function}
# load the packages
library(Hmisc)   
library(flextable)
library(tidyverse)
library(reshape2)
library(ggpubr)
cal <- function(n,p,nrep){
  set.seed (1)
  # calculate confidence interval
  CI <- data.frame(matrix(nrow=nrep, ncol=6))
  colname <-  c("asym_L", "asym_U","wil_L","wil_U","exact_L","exact_U")
  colnames(CI) <- colname
  for (i in 1:nrep){
    sample<-rbinom(n,1,p)
    ci<-binconf(sum(sample),n,method="all")
    CI$asym_L[i]<- ci[3,2]
    CI$asym_U[i]<- ci[3,3]
    CI$wil_L[i]<- ci[2,2]
    CI$wil_U[i]<- ci[2,3]
    CI$exact_L[i]<- ci[1,2]
    CI$exact_U[i]<- ci[1,3]}
  
  # coverage probability
  cp_asym <- sum(CI$asym_L <= p & p <= CI$asym_U)/nrep
  cp_wil <- sum(CI$wil_L <= p & p <= CI$wil_U)/nrep
  cp_exact <- sum(CI$exact_L <= p & p <= CI$exact_U)/nrep
  
  # CI width
  wid_asym <- mean(CI$asym_U-CI$asym_L)
  wid_wil <- mean(CI$wil_U-CI$wil_L)
  wid_exact <- mean(CI$exact_U-CI$exact_L)
  
  output<-list("cp_asym"=cp_asym,"cp_wil"=cp_wil,"cp_exact"=cp_exact,
               "wid_asym"=wid_asym,"wid_wil"=wid_wil,"wid_exact"=wid_exact)
  return(output)}
```

<br>

### Tables

```{r tables}
n<-c(20,40,100)
p<-c(0.05,0.15)

# table for coverage probability
## loop over to calculate values for different sample size and probability
table <- data.frame(matrix(nrow=3, ncol=6))
rownames(table) <- c("n = 20","n = 40","n = 100")
table1 <- data.frame(matrix(nrow=3, ncol=6))
rownames(table1) <- c("n = 20","n = 40","n = 100")

for (i in 1:3){
    a <- cal(n[i],p[1],20000)
    b <- cal(n[i],p[2],20000)
    table[i,1:6]<-c(sprintf("%0.5f",a[[1]]),sprintf("%0.5f",a[[2]]),sprintf("%0.5f",a[[3]]),sprintf("%0.5f",b[[1]]),sprintf("%0.5f",b[[2]]),sprintf("%0.5f",b[[3]]))
    table1[i,1:6]<-c(sprintf("%0.5f",a[[4]]),sprintf("%0.5f",a[[5]]),sprintf("%0.5f",a[[6]]),sprintf("%0.5f",b[[4]]),sprintf("%0.5f",b[[5]]),sprintf("%0.5f",b[[6]]))
}
n <- data.frame(n = row.names(table))
table<-cbind(n,table) 
n1 <- data.frame(n = row.names(table1))
table1<-cbind(n1,table1)

# form a table for coverage probability
table %>%  flextable()  %>% set_header_labels(n="", X1 = "Asymptotic",X2 = "Wilson", X3 = "Exact", "col_1",X4 = "Asymptotic",X5="Wilson",X6="Exact")  %>% 
  add_header_row(values = c("" ,"", "p = 0.05", "", "","p = 0.15", ""), top = TRUE ) %>% theme_booktabs() %>% autofit() %>% empty_blanks() %>%  set_caption('Table 1. Coverage Probability') %>% align(align = "center", part = "all")
```

\newpage

```{r tables1}
# form a table for Interval Width
table1 %>%  flextable()  %>% set_header_labels(n="",X1 = "Asymptotic",X2 = "Wilson", X3 = "Exact", "col_1",X4 = "Asymptotic",X5="Wilson",X6="Exact") %>% 
  add_header_row(values = c( "" ,"", "p = 0.05", "", "","p = 0.15", ""), top = TRUE )  %>% theme_booktabs() %>% autofit() %>% empty_blanks() %>%  
  set_caption('Table 2. Interval Width') %>% align(align = "center", part = "all") 
```

\newpage

### Plots

```{r plots1,fig.height=10,fig.width=10,dpi=1000}
# loop over to calculate the values for different sample size and probability
n <- c(20,40,100)
cpp <- cbind(n,data.frame(matrix(nrow=3, ncol=6)))
names(cpp)<-c("n","Asymptotic_0.05","Wilson_0.05","Exact_0.05",
              "Asymptotic_0.15","Wilson_0.15","Exact_0.15")
cpp_iw <- cbind(n,data.frame(matrix(nrow=3, ncol=6)))
names(cpp_iw)<-c("n","Asymptotic_0.05","Wilson_0.05","Exact_0.05",
                 "Asymptotic_0.15","Wilson_0.15","Exact_0.15")
for (i in 1:3){
  calc <- cal(n[i],0.05,20000)
  calc1 <- cal(n[i],0.15,20000)
  cpp[i,2:7] <- c(calc[[1]],calc[[2]],calc[[3]],calc1[[1]],calc1[[2]],calc1[[3]])
  cpp_iw[i,2:7] <- c(calc[[4]],calc[[5]],calc[[6]],calc1[[4]],calc1[[5]],calc1[[6]])
}

col = c("orange","purple","darkgreen")
# plot coverage probability
## p = 0.05
fin<-melt(cpp[1:4],id="n")
names(fin)<-c("n","Method","CP")
p1<-ggplot()+
  geom_smooth(data=fin,aes(x=n,y=CP,color=Method,group=Method),size=1)+
  labs(title =" Coverage Probability p = 0.05", x = "Sample Size", y = "Coverage Probability") +
  scale_color_manual(values=col,name = "Method", labels = c("Asymptotic", "Wilson", "Exact"))+
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5,size=16),text = element_text(size = 14))+
  ylim(0.6,1)

## p = 0.15
fin1<-melt(select(cpp,1,5,6,7),id="n")
names(fin1)<-c("n","Method","CP")
p2<-ggplot()+
  geom_smooth(data=fin1,aes(x=n,y=CP,color=Method,group=Method),size=1)+
  labs(title =" Coverage Probability p = 0.15", x = "Sample Size", y = "Coverage Probability") +
  scale_color_manual(values=col,name = "Method", labels = c("Asymptotic", "Wilson", "Exact"))+
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5,size=16),text = element_text(size = 14))+
  ylim(0.6,1)

# plot Interval Width
## p = 0.05
iw<-melt(cpp_iw[1:4],id="n")
names(iw)<-c("n","Method","CP")
p3<-ggplot()+
  geom_smooth(data=iw,aes(x=n,y=CP,color=Method,group=Method),size=1)+
  labs(title =" Interval Width p = 0.05", x = "Sample Size", y = "Interval Width") +
  scale_color_manual(values=col,name = "Method", labels = c("Asymptotic", "Wilson", "Exact"))+
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5,size=16),text = element_text(size = 14))+
  ylim(0.05,0.35)

## p = 0.15
iw1<-melt(select(cpp_iw,1,5,6,7),id="n")
names(iw1)<-c("n","Method","CP")
p4<-ggplot()+
  geom_smooth(data=iw1,aes(x=n,y=CP,color=Method,group=Method),size=1)+
  labs(title =" Interval Width p = 0.15", x = "Sample Size", y = "Interval Width") +
  scale_color_manual(values=col,name = "Method", labels = c("Asymptotic", "Wilson", "Exact"))+
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5,size=16),text = element_text(size = 14))+
  ylim(0.05,0.35)

p<-ggarrange(p1, p2, p3, p4, ncol = 2, nrow = 2 ,common.legend = TRUE,font.label = list(size = 14))
annotate_figure(p, top = text_grob("Figure 1: Measures of performance by varying conditions", face = "bold", size = 20))
```

\newpage

## Part 2

Based on the simulation results from Part 1, we would like to use the **Wilson** interval estimation method due to the following reasons: 
 
(1) Concerning the coverage probability, it is easy to see that the coverage probability of asymptotic interval is much lower than that of Wilson interval and Exact binomial interval given that the true mortality percentages are *0.05* and *0.15*, especially when the sample size is small. Therefore, it seems that the asymptotic interval method is not the most appropriate one to use. 
 
(2) Concerning the CI width, the plots clearly show that the CI width of Wilson interval is smaller than that of Exact binomial interval in all cases. 

Thus, we would like to select **Wilson** interval estimation method since it has similar coverage probability compared to Exact binomial interval but with a smaller interval width.

\newpage

## Part 3
 
```{r part3}
# read in data
data <- read_csv(here::here("mortality_data.csv"))
# review the data
glimpse(data,width = 60)
# data cleaning
data$sex[data$sex != "F" & data$sex != "M"] <- NA
data$death[data$death != 0 & data$death != 1] <- NA
# calculate confidence interval
CI_data <- binconf(sum(data$death),length(data$death),method="wilson")
# omit the missing data
data <- na.omit(data)
# calculate confidence interval in each sex group
dat_F <- data %>% filter(sex=="F")
CI_datF<-binconf(sum(dat_F$death),length(dat_F$death),method="wilson")
dat_M <- data %>% filter(sex=="M")
CI_datM<-binconf(sum(dat_M$death),length(dat_M$death),method="wilson")

# form a table
type <- c("Overall","Female","Male") 
size<- c("62","36","25")
final_CI <- cbind(data.frame(type),cbind(data.frame(size)),data.frame(rbind(sprintf("%0.4f",CI_data[1:3]),sprintf("%0.4f",CI_datF[1:3]),sprintf("%0.4f",CI_datM[1:3]))))
final_CI %>%  flextable()  %>% set_header_labels(type="",size="Sample Size", X1="Point Estimation",X2="Lower",X3 = "Upper") %>%  theme_booktabs() %>% autofit() %>% empty_blanks() %>% set_caption('Table 3. Wilson Confidence Interval') %>% align(align = "center", part = "all") 
```

Note: Here we include the missing data when calculating the overall death rate since the missing sex data will not affect the overall proportion of deaths. However, when calculating death rate of each sex group, since we cannot identify the sex of one specific patient, we omit the data of that patient.
